<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Webcam Recording</title>
        <style>
            #myVideo {
                border: 1px solid black;
                width: 640px;
                height: 480px;
            }

            button{
                margin-top: 10px;
            }
        </style>
    </head>

    <body>
        <h1>Webcam Recording</h1>

        <!-- 비디오 스트림을 표기 -->
        <div>
            <video id="myVideo" width="640" height="640" autoplay></video>
        </div>
        <!-- 녹화 시작 및 중지 버튼 -->
        <button id="startRecording">녹화 시작</button>
        <button id="stopRecording" disabled>녹화 중지</button>

        <script>
            let videoElement = document.getElementById('myVideo');
            let mediaRecorder;
            let recordedChunks = [];
            startCamera();
            // webcam 스트림 데이터를 받아서 화면에 표기
            async function startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: false
                    })

                    videoElement.srcObject = stream;
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = (event) => {
                        if(event.data.size > 0 ){
                            recordedChunks.push(event.data);
                        }
                    }
                    mediaRecorder.onstop = () => {
                        const b = new Blob(recordedChunks, { type: 'video/webm' });
                        
                        //uploadVideo(b);
                        recordedChunks = [];
                    }
                } catch (error) {
                    console.error('Error accessing webcam: ', error);
                }
            }

            async function uploadVideo(blob) {
                const formData = new FormData();
                formData.append('video', blob, 'video.webm');
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if(res.ok){
                        const fileBlob = await res.blob();
                        const downloadUrl = URL.createObjectURL(fileBlob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = 'recorded_video.mp4';
                        a.click();
                    } else {
                        alert('Video upload failed.');
                    }
                } catch (error) {
                    console.error('Error uploading video: ', error);
                }
            }

            document
            .getElementById('startRecording')
            .addEventListener('click', () => {
                if( mediaRecorder && mediaRecorder.state === 'inactive' ){
                    mediaRecorder.start();
                    document.getElementById('stopRecording').disabled = false;
                    document.getElementById('startRecording').disabled = true;
                    console.log('Recording started');
                }
            });

            document
            .getElementById('stopRecording')
            .addEventListener('click', () => {
                if(mediaRecorder && mediaRecorder.state === 'recording' ){
                    mediaRecorder.stop();
                    document.getElementById('stopRecording').disabled = true;
                    document.getElementById('startRecording').disabled = false;

                    console.log('Recording stopped');
                }
            });
        </script>
    </body>
    
</html>